#This script configures a Telegram bot to ask new members questions to avoid spam acounts. 
#new members have 30 secunds to answer the questions. If they dont they are kiked out. 
pip instal python-telegram-bot

from telegram import Update
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

pending_users = {}

questions = {
    1: {"question": "Hvilken by spiller vi FS i? (Du har 30 sekunder på å svare)", "correct_answers": ["Oslo"]},
    2: {"question": "Hvilken farve er det på laget ditt? (Du har 30 sekunder på å svare)", "correct_answers": ["grønn", "blå"]}
}

def welcome(update: Update, context: CallbackContext):
    """Sender første spørsmål når en ny bruker blir med i gruppen."""
    userid = update.message.new_chat_members[0].id
    chatid = update.message.chat.id
    pending_users[userid] = {"chatid": chatid, "question_stage": 1}
    context.bot.send_message(chatid, questions[1]["question"])
    context.job_queue.run_once(kick_user, 30, context=(chatid, userid))  # Tidsfrist på 30 sek

def check_answer(update: Update, context: CallbackContext):
    """Kontrollerer brukerens svar og sender neste spørsmål eller fjerner dem."""
    userid = update.message.from_user.id
    if userid in pending_users:
        stage = pending_users[userid]["question_stage"]
        user_answer = update.message.text.strip().lower()

        if user_answer in [answer.lower() for answer in questions[stage]["correct_answers"]]:
            if stage == 1:  # Hvis første spørsmål er riktig, gå til neste
                pending_users[userid]["question_stage"] = 2
                context.bot.send_message(update.message.chat.id, questions[2]["question"])
                context.job_queue.run_once(kick_user, 30, context=(update.message.chat.id, userid))  # Ny 30 sek frist
            else:  # Hvis begge spørsmål er riktig, fjern brukeren fra listen
                del pending_users[userid]
        else:  # Hvis feil svar, fjern brukeren
            kick_user(update.message.chat.id, userid, context)

def kick_user(context: CallbackContext):
    """Fjerner brukere som ikke har svart innen fristen."""
    chatid, userid = context.job.context
    if userid in pending_users:
        context.bot.kick_chat_member(chatid, userid)
        del pending_users[userid]

updater = Updater("<bot_id>")
dp = updater.dispatcher
dp.add_handler(MessageHandler(Filters.status_update.new_chat_members, welcome))
dp.add_handler(MessageHandler(Filters.text & ~Filters.command, check_answer))

updater.start_polling()
updater.idle()
